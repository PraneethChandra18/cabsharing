<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    {% load static %}
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script src='https://kit.fontawesome.com/a076d05399.js'></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="{% static 'cabshare/style.css' %}" type="text/css" />

    <title>{% block title %}CabShare{% endblock %}</title>
  </head>
  <body>
    <div class="modal" id="myModalsearch">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title"> Search </h4>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>

          <div class="modal-body">
            <form  action="{% url 'cabshare:search' %}" method="get">
              <div class="form-group row">
                <label for="search"> Destination  : </label>
                <input type="text" placeholder="Search for your destination" id="search" name="destination" value="{{ request.GET.destination }}">
              </div>
              <div class="form-group row">
                <label for="date"> Date  : </label>
                <input type="date" id="date" name="date" value="{{ request.GET.date}}">
              </div>

              <!-- <input class="form-control mr-sm-2" type="time" name="time" value="{{ request.GET.time}}"> -->

              <button class="btn btn-success" type="submit">Search</button>
            </form>
          </div>
        </div>
      </div>
    </div>


    <nav class="navbar navbar-expand-md bg-dark navbar-dark fixed-top">
      <a class="navbar-brand" href="{% url 'cabshare:index'%}"><span style="font-family:American Typewriter, serif"><img src="{% static 'cabshare/logo.jpg' %}" alt="logo" style="height:40px; width: 150px;"></span></a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#topNavbar">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="topNavbar">
        <div class="mx-auto order-0">
          <button type="button" class="btn btn-light" data-toggle="modal" data-target="#myModalsearch"> Search for suitable booking... </button>
        </div>
<!-- <ul class="navbar-nav ml-auto justify-content-end">    ->Can also use this to make it align right-->
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="{% url 'cabshare:notifications' %}" data-toggle="tooltip" data-placement="bottom" title="Notifications">
              <i class="material-icons">notifications</i>
                <span id="notifier">
                  {% if notifications_all.count %}
                    <span class="badge badge-pill badge-danger">
                        {{ notifications_all.count }}
                    </span>&nbsp;
                  {% endif %}
                </span>
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="{% url 'cabshare:booking-add' %}" data-toggle="tooltip" data-placement="bottom" title=" New Booking"><i class='fas fa-plus'></i> Add Booking&nbsp;</a>
          </li>

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbardrop" data-toggle="dropdown"><i class='fas fa-user'></i>&nbsp;</a>
            <div class="dropdown-menu dropdown-menu-right">
              <a class="dropdown-item" href="{% url 'account:profile-view' %}">Profile</a>
              <a class="dropdown-item" href="{% url 'cabshare:my_bookings' %}">My Bookings</a>
              <a class="dropdown-item" href="{% url 'cabshare:myrequests' %}">My Requests</a>
              <a class="dropdown-item" href="{% url 'cabshare:mychats' %}">My Chats</a>
              <a class="dropdown-item" href="{% url 'account:logout' %}">Logout</a>
            </div>
          </li>
        </ul>
      </div>
    </nav>
    <div class="container-fluid" style="margin-top:80px">
      {% block body %}
      {% endblock %}
    </div>
<div style="display:none">
  <input type="text" id="notification_count" value="{{ notifications_all.count }}">
</div>

    <script type="text/javascript">
      const notificationSocket = new WebSocket('ws://'+ window.location.host+ '/ws/notification/');
      notificationSocket.onmessage = function(message) {
          var d = JSON.parse(message.data);
          var from_pk = {{user.pk}};
          var ct = document.getElementById("notification_count")
          var count = Number(ct.value)
          count = count + 1
          ct.value = count.toString()
          html = '<span class="badge badge-pill badge-danger">'+ count +'</span>&nbsp;'
          if(d.to_user == from_pk && d.type!="message")
          {
            document.getElementById("notifier").innerHTML = html
          }
          if(d.type=="message")
          {
            var s = document.getElementById(d.from_user)
            var x = Number(s.value);
            x=x+1
            s.value = x.toString()
            document.getElementById(d.from_user).innerHTML = '<span class="badge badge-pill badge-success">'+ x +'</span>&nbsp;'
          }

      };

     function request(d) {
        var data = {
            from_user: $('#from_user_pk').val(),
            type: "request",
            to_user: d.getAttribute('value'),
            message: "Request to join you on your journey",
        }
        notificationSocket.send(JSON.stringify(data));
        return false;
      }

     function accept(d) {
        var st = $('#from_username').val()
        var data = {
            from_user: $('#from_user_pk').val(),
            type: "accept",
            to_user: d.getAttribute('value'),
            message: "Your request to join "+ st +" was accepted! Happy Journey!",
        }
        notificationSocket.send(JSON.stringify(data));
        return false;
      }

    $("#chatform").on("submit", function(event) {
      var data = {
        from_user: $('#from_user_pk').val(),
        type: "message",
        to_user: $('#to_user_pk').val(),
        message: "You have a message",
    }
    notificationSocket.send(JSON.stringify(data));
    return false;
   });
    </script>

  </body>
</html>
